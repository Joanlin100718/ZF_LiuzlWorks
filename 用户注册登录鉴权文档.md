# 用户注册登录鉴权文档v1.2.5

| 版本号 | 更新时间 | 更新人 | 更新内容                                                     |
| ------ | -------- | ------ | ------------------------------------------------------------ |
| v1.0.0 | 20220106 | 孙中辉 | 初始化文档                                                   |
| v1.0.1 | 20220107 | 孙中辉 | 1. 单点登录方案增加参数名称                                  |
|        |          |        | 2. token校验 返回值增加过期时间                              |
|        |          |        | 3. 增加 获取用户列表接口                                     |
|        |          |        | 4. 增加 获取机构列表接口                                     |
| v1.1.0 | 20220108 | 孙中辉 | 1. 登录接口拆成两个                                          |
|        |          |        | 2. 接口是否校验权限说明                                      |
|        |          |        | 3. 新增 获取用户信息接口                                     |
|        |          |        | 4. 新增 更新用户信息接口                                     |
|        |          |        | 5. 新增 密码修改接口                                         |
|        |          |        | 6. JWT 改成 公私钥模式增加安全性                             |
|        |          |        | 7.  C端用户注册接口  男 女用编码表示，返回的token有效期改为长期 |
|        |          |        | 8. 后台管理用户注册接口 去掉角色字段                         |
|        |          |        | 9. 附录 - 用户类型编码修改                                   |
|        |          |        | 10. 接口地址统一前缀 /zt                                     |
| v1.1.1 | 20220112 | 孙中辉 | 1. 测试接口地址                                              |
| v1.2.0 | 20220114 | 孙中辉 | 1. 获取系统用户信息接口修改                                  |
|        |          |        | 2. 新增 系统用户信息更新接口                                 |
|        |          |        | 3. 新增 系统用户删除接口                                     |
|        |          |        | 4. 新增 系统用户更新密码接口                                 |
| v1.2.2 | 20220118 | 孙中辉 | 1. 系统用户注册不校验删除状态                                |
|        |          |        | 2. 系统用户更新密码 可以传userId，不传默认登陆userId         |
| v1.2.3 | 20220120 | 孙中辉 | 1. 获取系统用户信息 返回userType字段                         |
|        |          |        | 2. jwt生成token增加userType字段                              |
| v1.2.4 | 20220121 | 孙中辉 | 1. jwt密钥改成2048                                           |
| v1.2.5 | 20220122 | 孙中辉 | 1. 增加kafka测试地址                                         |
|        |          |        | 2. 系统用户注册，系统用户更新，系统用户删除 增加kafka主题信息 |
|        |          |        |                                                              |

​		


## 测试地址

{{address}}

http://192.168.165.204/prod-api

Kafka

192.168.165.203:9092

## C端用户注册接口

#### 接口URL

http://{{address}}/zt/register/client 

#### 请求方式

POST   （开放接口，不带token权限校验）

#### Content-Type

application/json

| 字段 | 名称 | 是否必填 | 备注         |
| -------------- | -------------- | ------------------ | ---------------------- |
| username       | 用户名         | 必填               | 用户登录系统的账户     |
| password      | 密码           | 必填               | 用户登录系统的账户密码 |
| nickName       | 姓名         | 必填               | 用户姓名               |
| idCard | 身份证号 | 必填 | 身份证号18位 |
| nati | 民族 | 必填 |  |
| org | 单位 | 必填 | 格式A.B(A为B上级单位，如30所.三部) |
| sex | 性别 | 必填 | 0男\|1女 |
| post | 职务 | 必填 | 职务 |
| location | 位置 | 必填 | 所属位置 |
| mobile         | 手机号         | 必填               | 系统自动携带手机号     |
| imsi           | IMSI           | 必填               | 系统自动携带IMSI       |
| imei           | IMEI           | 必填               | 系统自动携带IMEI       |
| iccid          | ICCID          | 必填               | 系统自动携带ICCID      |
| birthday | 出生日期 | 非必填 | 2021-10-10 |

#### 请求Body参数

```json
{
  "username":"", 
   "password":"",
   "nickName":"" ,
   "idCard":"",
   "nati":"" ,
   "org":"",
   "sex":"" ,
   "post":"",
   "location":"" ,
   "mobile":"",
   "imsi":"",
   "imei":"" ,
   "iccid":"",
   "birthday":""
}
```

#### 响应字段

| 字段    | 名称 | 是否必填 | 备注            |
| ----------------- | -------------- | ------------------ | ------------------------- |
| code              | 状态码 | 必填               | 接口返回的状态码200是成功 |
| msg               | 描述           | 必填               | 接口返回的消息描述        |
| data              |                | 必填               | 接口返回的数据            |
| ~~data.access_token~~ | ~~token~~      | ~~必填~~           | ~~用户登录token~~         |
| ~~data.expires_in~~ | ~~过期时间~~   | ~~必填~~           | ~~token过期时间（分钟）~~ |
| ~~data.expires_time~~ | ~~过期时间~~   | ~~必填~~           | ~~token过期时间（毫秒数）~~ |

#### 成功响应示例
```json
{
   "code":200,
   "msg":"注册成功",
   "data":{
     "access_token":"eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX2tleSI6IjBiYzgxMWY3LWE2YjUtNDc3NC04MzAwLTI3ODU2NThmNzhlYiIsImV4cGlyZV90aW1lIjoxNjQxNTEzMjE1Mzc5LCJ1c2VybmFtZSI6ImFkbWluIn0.CgXw6tFTAO9PjS7sAuYTEUIXtPcRIcbgBnbIM1WxhJ1cxplNqGKSROU6T-N_f0CLocv55al9EpCMWbVsazNhHQ"
   }
}
```
## 开发者注册接口

#### 接口URL

http://{{address}}/zt/register/developer   

#### 请求方式

POST（开放接口，不带token权限校验）

#### Content-Type

application/json

| 字段  | 名称   | 是否必填 | 备注           |
| --------------- | ---------------- | ------------------ | ------------------------ |
| username        | 用户名           | 必填               | 用户登录系统的账户       |
| password        | 密码             | 必填               | 用户登录系统的账户密码   |
| mobile          | 手机号           | 必填               | 企业手机号               |
| companyName     | 企业名称         | 必填               | 企业名称                 |
| uscc            | 统一社会信用代码 | 必填               | 统一社会信用代码         |
| businessLicense | 营业执照         | 必填               | png base64 格式，大小<1M |

#### 请求Body参数
```json
{
  "username":"",
   "password":"",
   "mobile":"",
   "companyName":"",
   "uscc":"",
   "businessLicense":""
}
```
#### 响应字段

| 字段    | 名称 | 是否必填 | 备注             |
| ----------------- | -------------- | ------------------ | -------------------------- |
| code              | 状态码         | 必填               | 接口返回的状态码 200是成功 |
| msg               | 描述           | 必填               | 接口返回的消息描述         |
| data              |                | 必填               | 接口返回的数据             |
| data.accessKeyId  | AccessKey ID   | 必填               | 开发者用户的AccessKey ID   |
| data.secretId     | SecretId       | 必填               | 开发者用户的SecretId       |
| data.access_token | token          | 必填               | 用户登录的token            |
| data.expires_in   | 过期时间       | 必填               | token的过期时间（分钟）    |
| data.expires_time | 过期时间       | 必填               | token过期时间（毫秒数）    |

#### 成功响应示例
```json
{
   "code":200,
   "msg":"注册成功",
   "data":{
     	"accessKeyId":"",
      	"secretId":"",
"access_token":"eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX2tleSI6IjBiYzgxMWY3LWE2YjUtNDc3NC04MzAwLTI3ODU2NThmNzhlYiIsImV4cGlyZV90aW1lIjoxNjQxNTEzMjE1Mzc5LCJ1c2VybmFtZSI6ImFkbWluIn0.CgXw6tFTAO9PjS7sAuYTEUIXtPcRIcbgBnbIM1WxhJ1cxplNqGKSROU6T-N_f0CLocv55al9EpCMWbVsazNhHQ",
   "expires_in":720,
   "expires_time":1641513215379
   }
}
```

## 后台管理用户注册接口（完成）

#### 描述

> 调用后台管理注册接口，注册成功会进行 Kafka 通知，Kafka主题配置：

- **topic：sys_user_add**
- **分组id请带上各中台 userType 避免重复**

#### 接口URL

http://{{address}}/zt/register/sys   

#### 请求方式

POST   （开放接口，不带token权限校验）

#### Content-Type

application/json

| 字段 | 名称     | 是否必填 | 备注                                          |
| -------------- | ------------------ | ------------------ | ------------------------------------------------------- |
| userId | 用户ID | 必填 | 用户ID |
| userName       | 用户名             | 必填               | 用户登录系统的账户                                      |
| password       | 密码               | 必填               | 用户登录系统的账户密码                                  |
| mobile         | 手机号             | 必填               | 用户手机号                                              |
| nickName       | 昵称               | 必填               | 用户昵称                                                |
| userType       | 用户类型 integer   | 必填               | 用户类型 -> 参照用户类型表格【附录 - 用户类型】         |
| ~~roleIds~~    | ~~角色id列表 integer~~ | ~~必填~~           | ~~角色id列表, 调用 角色接口 获取 【附录 - 获取角色列表 】~~ |

#### 请求Body参数
```json
{
    "userId":"",
  "userName":"",
   "password":"",
   "mobile":"",
   "nickName":"",
   "userType":["01","02","03"]
}
```

#### 响应字段

| 字段    | 名称 | 是否必填 | 备注             |
| ----------------- | -------------- | ------------------ | -------------------------- |
| code              | 状态码         | 必填               | 接口返回的状态码 200是成功 |
| msg               | 描述           | 必填               | 接口返回的消息描述         |
| data              |                | 必填               | 接口返回的数据             |
| data.access_token | token          | 必填               | 用户登录的token            |
| data.expires_in   | 过期时间       | 必填               | token的过期时间（分钟）    |
| data.expires_time | 过期时间       | 必填               | token过期时间（毫秒数）    |

#### 成功响应示例
```json
{
   "code":200,
   "msg":"注册成功",
   "data":{
     "access_token":"eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX2tleSI6IjBiYzgxMWY3LWE2YjUtNDc3NC04MzAwLTI3ODU2NThmNzhlYiIsImV4cGlyZV90aW1lIjoxNjQxNTEzMjE1Mzc5LCJ1c2VybmFtZSI6ImFkbWluIn0.CgXw6tFTAO9PjS7sAuYTEUIXtPcRIcbgBnbIM1WxhJ1cxplNqGKSROU6T-N_f0CLocv55al9EpCMWbVsazNhHQ",
   "expires_in":720,
   "expires_time":1641513215379
   }
}
```

## C端用户登录接口

#### 接口URL

> http://{{address}}/zt/auth/login

#### 请求方式

> POST  （开放接口，不带token权限校验）

#### Content-Type

> application/json

| 字段     | 名称   | 是否必填 | 备注                   |
| -------- | ------ | -------- | ---------------------- |
| username | 用户名 | 必填     | 用户登录系统的账户     |
| password | 密码   | 必填     | 用户登录系统的账户密码 |


#### 请求Body参数

```json
{"username":"test","password":"123456"}
```

#### 响应字段

| 字段                  | 名称         | 是否必填 | 备注                        |
| --------------------- | ------------ | -------- | --------------------------- |
| code                  | 状态码       | 必填     | 接口返回的状态码200是成功   |
| msg                   | 描述         | 必填     | 接口返回的消息描述          |
| data                  |              | 必填     | 接口返回的数据              |
| data.access_token     | token        | 必填     | 用户登录token               |
| ~~data.expires_in~~   | ~~过期时间~~ | ~~必填~~ | ~~token过期时间（分钟）~~   |
| ~~data.expires_time~~ | ~~过期时间~~ | ~~必填~~ | ~~token过期时间（毫秒数）~~ |

#### 成功响应示例

```json
{
    "code":200,"msg":null,
 	"data":{
     "access_token":"eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX2tleSI6IjBiYzgxMWY3LWE2YjUtNDc3NC04MzAwLTI3ODU2NThmNzhlYiIsImV4cGlyZV90aW1lIjoxNjQxNTEzMjE1Mzc5LCJ1c2VybmFtZSI6ImFkbWluIn0.CgXw6tFTAO9PjS7sAuYTEUIXtPcRIcbgBnbIM1WxhJ1cxplNqGKSROU6T-N_f0CLocv55al9EpCMWbVsazNhHQ",
    }
}
```

## 系统用户登录接口（完成）

#### 接口URL

> http://{{address}}/zt/auth/syslogin

#### 请求方式

> POST  （开放接口，不带token权限校验）

#### Content-Type

> application/json

| 字段     | 名称   | 是否必填 | 备注                   |
| -------- | ------ | -------- | ---------------------- |
| username | 用户名 | 必填     | 用户登录系统的账户     |
| password | 密码   | 必填     | 用户登录系统的账户密码 |


#### 请求Body参数

```json
{"username":"test","password":"123456"}
```

#### 响应字段

| 字段              | 名称     | 是否必填 | 备注                      |
| ----------------- | -------- | -------- | ------------------------- |
| code              | 状态码   | 必填     | 接口返回的状态码200是成功 |
| msg               | 描述     | 必填     | 接口返回的消息描述        |
| data              |          | 必填     | 接口返回的数据            |
| data.access_token | token    | 必填     | 用户登录token             |
| data.expires_in   | 过期时间 | 必填     | token过期时间（分钟）     |
| data.expires_time | 过期时间 | 必填     | token过期时间（毫秒数）   |

#### 成功响应示例

```json
{
    "code":200,"msg":null,
 	"data":{
     "access_token":"eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX2tleSI6IjBiYzgxMWY3LWE2YjUtNDc3NC04MzAwLTI3ODU2NThmNzhlYiIsImV4cGlyZV90aW1lIjoxNjQxNTEzMjE1Mzc5LCJ1c2VybmFtZSI6ImFkbWluIn0.CgXw6tFTAO9PjS7sAuYTEUIXtPcRIcbgBnbIM1WxhJ1cxplNqGKSROU6T-N_f0CLocv55al9EpCMWbVsazNhHQ",
     "expires_in":720,
     "expires_time":1641513215379
    }
}
```



## 获取系统用户信息接口（完成）

#### 接口URL

> http://{{address}}/zt/system/user/{id}

#### 请求方式

> GET  （需要带token权限校验，详情查看 - Token 请求规范）

#### Content-Type

> application/json

| 字段 | 名称   | 是否必填 | 备注                                   |
| ---- | ------ | -------- | -------------------------------------- |
| id   | 用户id | 非必填   | 地址不加【用户id】默认返回登陆人的信息 |


#### 请求GET参数

```json
/zt/system/user/{id}
```

#### 响应字段

| 字段             | 名称       | 是否必填 | 备注                      |
| ---------------- | ---------- | -------- | ------------------------- |
| code             | 状态码     | 必填     | 接口返回的状态码200是成功 |
| msg              | 描述       | 必填     | 接口返回的消息描述        |
| data             | 数据列表   | 必填     |                           |
| data.userid      | 用户id     | 必填     |                           |
| data.deptId      | 用户机构id | 必填     |                           |
| data.userName    | 用户名     | 必填     |                           |
| data.nickName    | 用户姓名   | 必填     |                           |
| data.phonenumber | 手机号     | 必填     |                           |
| data.sex         | 性别       | 必填     |                           |
| data.createTime  | 创建时间   | 必填     |                           |
| data.status      | 用户状态   | 必填     | 0 正常 1禁用              |
| data.roles       | 角色列表   |          |                           |

#### 成功响应示例

```json
{
    "data":[
        {
            "createBy":"admin",
            "createTime":"2022-01-05 16:12:28",
            "remark":"管理员",
            "userId":1,
            "deptId":100,
            "userName":"admin",
            "nickName":"admin",
            "email":"hz@xx.com",
            "phonenumber":"15888888888",
            "sex":"1",
            "status":"0",
            "delFlag":"0",
            "roles":[]
        }
    ],
    "code":200,
    "msg":"查询成功"
}
```



## 系统用户更新接口（完成）

#### 描述

> 更新成功会进行 Kafka 通知，Kafka主题配置：

- **Topic：sys_user_update**
- **分组ID请带上各中台 userType 避免重复**

#### 接口URL

>  http://{{address}}/zt/system/user

#### 请求方式

> PUT（（需要带token权限校验，详情查看 - Token 请求规范）

#### Content-Type

> application/json

| 字段     | 名称             | 是否必填 | 备注                                            |
| -------- | ---------------- | -------- | ----------------------------------------------- |
| userId   | 用户ID           | 必填     | 用户ID                                          |
| mobile   | 手机号           | 非必填   | 用户手机号                                      |
| nickName | 昵称             | 非必填   | 用户昵称                                        |
| userType | 用户类型 integer | 非必填   | 用户类型 -> 参照用户类型表格【附录 - 用户类型】 |

#### 请求Body参数

```json
{
    "userId":"",
    "mobile":"",
    "nickName":"",
    "userType":["01","02","03"]
}
```

#### 响应字段

| 字段 | 名称   | 是否必填 | 备注                       |
| ---- | ------ | -------- | -------------------------- |
| code | 状态码 | 必填     | 接口返回的状态码 200是成功 |
| msg  | 描述   | 必填     | 接口返回的消息描述         |

#### 成功响应示例

```json
{
   "code":200,
   "msg":"更新成功",
}
```



## 系统用户删除接口（完成）

#### 描述

>  更新成功会进行 Kafka 通知，Kafka主题配置：

- **Topic：sys_user_update**
- **分组ID请带上各中台 userType 避免重复**

#### 接口URL

> http://{{address}}/zt/system/user/{id}

#### 请求方式

> DELETE  （需要带token权限校验，详情查看 - Token 请求规范）

#### Content-Type

> application/json

| 字段 | 名称   | 是否必填 | 备注       |
| ---- | ------ | -------- | ---------- |
| id   | 用户id | 必填     | 【用户id】 |


#### 请求GET参数

```json
/zt/system/user/{id}
```

#### 响应字段

| 字段 | 名称   | 是否必填 | 备注                       |
| ---- | ------ | -------- | -------------------------- |
| code | 状态码 | 必填     | 接口返回的状态码 200是成功 |
| msg  | 描述   | 必填     | 接口返回的消息描述         |

#### 成功响应示例

```json
{
   "code":200,
   "msg":"删除用户成功",
}
```



## 系统用户修改密码接口（完成）



#### 接口URL

>  http://{{address}}/zt/system/user/updatePwd

#### 请求方式

> PUT（（需要带token权限校验，详情查看 - Token 请求规范）

#### Content-Type

> application/json

| 字段        | 名称   | 是否必填 | 备注   |
| ----------- | ------ | -------- | ------ |
| userId      | 用户id | 非必填   | 用户id |
| newPassword | 新密码 | 必填     | 新密码 |

#### 请求Body参数

```json
{
    "userId":"",  //不传默认登录用户
    "newPassword":"",
}
```

#### 响应字段

| 字段 | 名称   | 是否必填 | 备注                       |
| ---- | ------ | -------- | -------------------------- |
| code | 状态码 | 必填     | 接口返回的状态码 200是成功 |
| msg  | 描述   | 必填     | 接口返回的消息描述         |

#### 成功响应示例

```json
{
   "code":200,
   "msg":"更新密码成功",
}
```

## 

## Token 请求规范

#### 请求附带header标识

格式：Authorization:Bearer {{access_token}}

通过登录接口登录，会在redis缓存登录信息，设置过期时间，对应登录返回的过期时间。

各中台可自己本地做token校验（不会校验业务中台redis），

也可以调用校验接口进行校验（会校验redis）

| KEY      | 标识                        |
| -------- | --------------------------- |
| 令牌Key  | Authorization               |
| 令牌前缀 | Bearer （后面有个英文空格） |
| Token    | token                       |
|          |                             |

#### 请求header示例

```
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VyX2tleSI6Ijg3NDU4NmU5LWFkNjctNGIwNS1hYmUzLThhZjc2ODZlY2NhYiIsImV4cGlyZV90aW1lIjoxNjQxODU3NjE0NTUzLCJpYXQiOjE2NDE4MTQ0MTQsInVzZXJuYW1lIjoiYWRtaW4ifQ.aS52YRvdvCk-lRVV6AbZf4eeLzjR3QndNM-GqQtnXTlU8Pjc8tCvW8sqnDhJKdmmKnhS71LSuCVtvDx0DSbO1kV2zY_I6eXWg02AjXm11UQZfbYyyB9eaQw2zUpw705nRvlDv27TN1cloZ3Ub-H1rkmz2gjl9uqS4iHN7ila_H0
```

## JWT校验方式



#### 本地校验

maven 引入

```java
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>

public class SecurityConstants
{
    /**
     * 公钥
     */
     public final static String publicKey = "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2aEzCfLulxWcyYGc64X+/KwbaOXHVSEtTDVzhG6RrNRG6yZundfFT0Expk/NoeMxw3etAcsSXCWwB0/gmkZjzugMEkV+skb300jJSgtUZ1L77N2Jp+QnSyWUsvHTmf11vtuJbVSP/8SZ7Lyb4+8J3P2abWzPVMk3e/YQR8qyheIPs0umyvEzqUbnxOLAAmBAKLEIXaL1R/U61EoiEBOdGxA3MCyn91SQ8bqgma3L0ZOBntHehimAjzIN6GYmt690eGuZwWBgRrrwSku0e5yoQc5mZAkndk7xszv6/P/ok6Dof/AnwuZi5/0LplPDkp8E25DUrM/KwQDsN5x6IR7mMQIDAQAB";


    /**
     * 用户ID字段
     */
    public static final String DETAILS_USER_ID = "user_id";

    /**
     * 用户名字段
     */
    public static final String DETAILS_USERNAME = "username";


    /**
     * 用户标识
     */
    public static final String USER_KEY = "user_key";
    

    /**
     * 过期时间
     */
    public static final String EXPIRE_TIME = "expire_time";
    
    /**
     * 用户类型
     */
    public static final String USER_TYPE = "user_type";
    
    

}

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import org.springframework.util.StringUtils;
import sun.misc.BASE64Decoder;
import java.math.BigDecimal;
import java.security.KeyFactory;
import java.security.PublicKey;
import java.security.spec.X509EncodedKeySpec;
import java.util.List;

/**
 * Jwt工具类
 *
 * @author hz
 */
public class JwtUtils
{

    /**
     * 从令牌中获取数据声明
     *
     * @param token 令牌
     * @return 数据声明
     */
    public static Claims parseToken(String token)
    {
        Claims claims = null;
        try {
            // 读取公钥
            String key = SecurityConstants.publicKey;
            // 生成签名公钥
            byte[] keyBytes = (new BASE64Decoder()).decodeBuffer(key);
            X509EncodedKeySpec keySpec = new X509EncodedKeySpec(keyBytes);
            KeyFactory keyFactory = KeyFactory.getInstance("RSA");
            PublicKey publicKey = keyFactory.generatePublic(keySpec);
            claims = Jwts.parser()
                    .setSigningKey(publicKey)
                    .parseClaimsJws(token).getBody();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return claims;
    }

    /**
     * 根据令牌获取用户标识
     *
     * @param token 令牌
     * @return 用户ID
     */
    public static String getUserKey(String token)
    {
        Claims claims = parseToken(token);
        return getValue(claims, SecurityConstants.USER_KEY);
    }

    /**
     * 根据令牌获取用户标识
     *
     * @param claims 身份信息
     * @return 用户ID
     */
    public static String getUserKey(Claims claims)
    {
        return getValue(claims, SecurityConstants.USER_KEY);
    }

    /**
     * 根据令牌获取用户ID
     *
     * @param token 令牌
     * @return 用户ID
     */
    public static String getUserId(String token)
    {
        Claims claims = parseToken(token);
        return getValue(claims, SecurityConstants.DETAILS_USER_ID);
    }

    /**
     * 根据身份信息获取用户ID
     *
     * @param claims 身份信息
     * @return 用户ID
     */
    public static String getUserId(Claims claims)
    {
        return getValue(claims, SecurityConstants.DETAILS_USER_ID);
    }

    /**
     * 根据令牌获取用户名
     *
     * @param token 令牌
     * @return 用户名
     */
    public static String getUserName(String token)
    {
        Claims claims = parseToken(token);
        return getValue(claims, SecurityConstants.DETAILS_USERNAME);
    }

    /**
     * 根据身份信息获取用户名
     *
     * @param claims 身份信息
     * @return 用户名
     */
    public static String getUserName(Claims claims)
    {
        return getValue(claims, SecurityConstants.DETAILS_USERNAME);
    }
    /**
     * 根据身份信息获取用户名
     *
     * @param claims 身份信息
     * @return 用户名
     */
    public static Long getExpireTime(Claims claims)
    {
        return getLong(claims, SecurityConstants.EXPIRE_TIME);
    }

    /**
     * 根据身份信息获取键值
     *
     * @param claims 身份信息
     * @param key 键
     * @return 值
     */
    public static String getValue(Claims claims, String key)
    {
        return toStr(claims.get(key), "");
    }
    public static Long getLong(Claims claims, String key)
    {
        return toLong(claims.get(key), 0L);
    }
    /**
     * 转换为字符串<br>
     * 如果给定的值为null，或者转换失败，返回默认值<br>
     * 转换失败不会报错
     *
     * @param value 被转换的值
     * @param defaultValue 转换错误时的默认值
     * @return 结果
     */
    public static String toStr(Object value, String defaultValue)
    {
        if (null == value)
        {
            return defaultValue;
        }
        if (value instanceof String)
        {
            return (String) value;
        }
        return value.toString();
    }

    public static Long toLong(Object value, Long defaultValue)
    {
        if (value == null)
        {
            return defaultValue;
        }
        if (value instanceof Long)
        {
            return (Long) value;
        }
        if (value instanceof Number)
        {
            return ((Number) value).longValue();
        }
        final String valueStr = toStr(value, null);
        if (StringUtils.isEmpty(valueStr))
        {
            return defaultValue;
        }
        try
        {
            // 支持科学计数法
            return new BigDecimal(valueStr.trim()).longValue();
        }
        catch (Exception e)
        {
            return defaultValue;
        }
    }
    // 获取分配的用户类型
    public static String[] getUserType(Claims claims)
    {
        try {
            List<String> userType = (List<String>) claims.get(SecurityConstants.USER_TYPE);
            return userType.toArray(new String[userType.size()]);
        } catch (Exception e) {
            return new String[0];
        }
    }


    public static void main(String[] args) throws Exception{
        Claims claims = JwtUtils.parseToken("eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ1c2VyX3R5cGUiOlsiMDEiLCIwMiJdLCJ1c2VyX2lkIjoiMyIsInVzZXJfa2V5IjoiMzgxNDg2YTMtNTgzMi00MDAxLTk1NTgtMjNjMWE0NzEzNTQyIiwiZXhwaXJlX3RpbWUiOjE2NDI3MTk2NjQ2OTYsImV4cCI6MTY0MjcxOTY2NCwiaWF0IjoxNjQyNjc2NDY0LCJ1c2VybmFtZSI6InRlc3Q1In0.fNDloKB9XxelRdA4qyi6zWCauKjvnMFZE_XsRua4hvhEawcfd5PM0BWVqLhnpAuN426g5vlWvHVdfkZWC0TG3KY5KkIvH1k3NO9xNcSyQSWmVAlY3dlKVsv98s5ulDZ68jOaHXwD3GZg-IQ5Fc9tYcFnmQg0MRvELM6ptgAHqi0");
       if(claims ==null){
           System.out.println("令牌校验失败或者令牌已过期");
           return;
       }
       System.out.println(claims);
        Long expireTime = JwtUtils.getExpireTime(claims);
        String userId = JwtUtils.getUserId(claims);
        String userName = JwtUtils.getUserName(claims);
        System.out.println(expireTime);//输出 1641509559930
        System.out.println(userId);//输出 1
        System.out.println(userName);//输出 admin
        System.out.println(JwtUtils.getUserType(claims).length);
    }
}



```

#### 接口校验

> http://{{address}}/zt/auth/verification

##### 请求方式

> POST

##### Header 参数

| KEY      | 标识                        |
| -------- | --------------------------- |
| 令牌Key  | Authorization               |
| 令牌前缀 | Bearer （后面有个英文空格） |
| Token    | token                       |
|          |                             |

##### 响应字段

| 字段             | 名称               | 是否必填 | 备注                                    |
| ---------------- | ------------------ | -------- | --------------------------------------- |
| code             | 状态码             | 必填     | 接口返回的状态码200 token有效，其余无效 |
| msg              | 描述               | 必填     | 接口返回的消息描述                      |
| data             | 数据               |          |                                         |
| data.user_id     | 用户id             | 必填     | 用户id                                  |
| data.expire_time | 过期time（毫秒数） | 必填     | 过期具体时间（毫秒）                    |
| data.username    | 用户名             | 必填     | 用户名                                  |
| data.user_type   | 用户类型           | 必填     | 用户类型 详情 附录 用户类型             |

##### 成功响应示例

```json
{
    "code": 200,
    "msg": "有效",
    "data":{
        "user_id": 1,
        "user_key": "17a20fc1-88a1-4bd3-a491-d4db6420aa40",
        "expire_time": 1641570621775,
        "username": "admin",
        user_type":[ "01", "02" ]
	}
}
```

## 单点登录方案



部署一个认证中心，比如门户做认证中心。

用户统一在认证中心进行登录，登录成功后，认证中心记录用户的登录状态，并将 Token 写入 Cookie。（注意这个 Cookie 是认证中心的，各个业务系统是访问不到的。）

各个业务系统检查当前请求有没有 Token，如果没有，说明用户在当前系统中尚未登录，那么就将页面跳转至认证中心。由于这个操作会将认证中心的 Cookie 自动带过去，因此，认证中心能够根据 Cookie 知道用户是否已经登录过了。

如果认证中心发现用户尚未登录，则返回登录页面，等待用户登录，如果发现用户已经登录过了，就不会让用户再次登录了，而是会跳转回目标 URL ，并在跳转前生成一个 Token，拼接在目标 URL 的后面，回传给各个业务系统。

各个业务系统拿到 Token 之后，还需要向认证中心确认下 Token 的合法性，防止用户伪造。确认无误后，各个业务系统记录用户的登录状态，并将 Token 写入 Cookie，然后给本次访问放行。（注意这个 Cookie 是当前业务系统的，其他业务系统是访问不到的。）当用户再次访问当前业务系统时，就会自动带上这个 Token，业务系统验证 Token 发现用户已登录，就不会再跟认证中心交互了。

跳转参数暂定：access_token

例如跳转到业务中台：http://{{address}}?access_token={{access_token}}

## 附录

#### 用户类型 string

| code | 名称         |
| ---- | ------------ |
| 01   | 业务中台     |
| 02   | PaaS组件     |
| 03   | 能力开放平台 |
| 04   | 系统运维平台 |
| 05   | 业务运维平台 |
| 06   | 开发平台     |
| 07   | 应用市场     |
| 08   | 数据中台     |
| 09   | 安全平台     |

#### 状态码 integer

| 状态码 | 备注               |
| ------ | ------------------ |
| 200    | 正确               |
| 401    | 未授权             |
| 403    | 访问受限，授权过期 |
| 500    | 系统内部错误       |

